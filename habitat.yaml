habitat: 1.0

Settings:
  Name: materialx
  InstallIncludesDebug: true
  DefaultVariant: VP21

Variables:
  # when branched for a release tag, update these
  MATERIALX_TAG_VERSION: "1.38.7"
  MATERIALX_VERSION: "1.38.7"
  MATERIALX_CODESAFE_VERSION: "1_38_7"
  MATERIALX_APP_VERSION: "${VERSION}"
  MATERIALX_SOVERSION: !Sub "${MATERIALX_TAG_VERSION}"
  MATERIALX_FULLSOVERSION: ${MATERIALX_APP_VERSION}

materialx_pak:
  Type: Weta::OZ::SimplePak
  PakNameOverride: materialx
  PakVariables:
    LD_LIBRARY_PATH: !Append "${INSTALL_PREFIX}/opt/%(WETA_VFXPLATFORM_ID)s/lib"
    PATH: !Append "${INSTALL_PREFIX}/opt/%(WETA_VFXPLATFORM_ID)s/bin"
    PYTHONPATH: !AppendFor ['python', "${INSTALL_PREFIX}/opt/%(WETA_VFXPLATFORM_ID)s/lib/python"]
  Library: materialx
  DeveloperVariables:
    LIBMATERIALX_LIBPATH: "${INSTALL_PREFIX}/opt/%(WETA_VFXPLATFORM_ID)s/lib"
    LIBMATERIALX_INCLUDES: "${INSTALL_PREFIX}/opt/%(WETA_VFXPLATFORM_ID)s/include"
    MaterialX_ROOT: !Append "${INSTALL_PREFIX}/opt/%(WETA_VFXPLATFORM_ID)s/lib/cmake/MaterialX"
  Requires:
    WetaVFXPlatform: ">=2019<2024"


compile_materialx:
  Type: Weta::OSS::CmakePackage
  VariantsOverride: [ VP19, VP19DBG, VP20py2, VP20py2DBG, VP21, VP21DBG, VP22, VP22DBG, VP23, VP23DBG ]
  BaseEnvironment:
    - cmake-3.27.7
    - ninja-1.10.2
    - patchelf-0.13.0
    - bison-3.8.2
    - libflex-2.6.4
    - doxygen-1.9.1
    - graphviz-2.38.0
    - texlive-2018.04.14
  PerVariantBuildEnvironments:
    VP19*:
      - python-2.7.15-weta.5
      - WetaVFXPlatform-2019.27.10
    VP20*:
      - python-2.7.15-weta.5
      - WetaVFXPlatform-2020.27.8
    VP21*:
      - python-3.7.3-weta.1
      - pyimportlib_metadata-4.8.1
      - WetaVFXPlatform-2021.37.10
    VP22*:
      - python-3.9.10-weta.1
      - pyimportlib_metadata-5.1.0-py39.1
      - WetaVFXPlatform-2022.0.13
    VP23*:
      - python-3.10.13
      - WetaVFXPlatform-2023.0.4
  PerVariantVariables:
    VP19*:
      BOB_ABI: L64
      OIIO_LOCATION: !Sub "/vol/bob/built/linux64/${BOB_ABI}/ext/OpenImageIO/tags/OpenImageIO-2.2-16.0-weta04"
    VP19:
      BLDTAG: opt
      GENDOCS: !If [!Equals [!Sub "${Project:IsDeployment}", "True"], "ON", "OFF"]
    VP19DBG:
      BLDTAG: dbg
      GENDOCS: OFF
    VP20*:
      BOB_ABI: L64
      OIIO_LOCATION: !Sub "/vol/bob/built/linux64/${BOB_ABI}/ext/OpenImageIO/tags/OpenImageIO-2.2-16.0-weta04"
    VP20py2:
      BLDTAG: opt
      GENDOCS: !If [!Equals [!Sub "${Project:IsDeployment}", "True"], "ON", "OFF"]
    VP20py2DBG:
      BLDTAG: dbg
      GENDOCS: OFF
    VP21*:
      BOB_ABI: L94
      OIIO_LOCATION: !Sub "/vol/bob/built/linux64/${BOB_ABI}/ext/OpenImageIO/tags/OpenImageIO-2.2-16.0-weta04"
    VP21:
      BLDTAG: opt
      GENDOCS: !If [!Equals [!Sub "${Project:IsDeployment}", "True"], "ON", "OFF"]
    VP21DBG:
      BLDTAG: dbg
      GENDOCS: OFF
    VP22*:
      BOB_ABI: L94
      OIIO_LOCATION: !Sub "/vol/bob/built/linux64/${BOB_ABI}/ext/OpenImageIO/tags/OpenImageIO-2.2-16.0-weta04"
    VP22:
      BLDTAG: opt
      GENDOCS: !If [!Equals [!Sub "${Project:IsDeployment}", "True"], "ON", "OFF"]
    VP22DBG:
      BLDTAG: dbg
      GENDOCS: OFF
    VP23*:
      BOB_ABI: L171
      OIIO_LOCATION: !Sub "/vol/bob/built/linux64/${BOB_ABI}/ext/OpenImageIO/tags/OpenImageIO-2.2-16.0-weta12"
    VP23:
      BLDTAG: opt
      GENDOCS: !If [ !Equals [ !Sub "${Project:IsDeployment}", "True" ], "ON", "OFF" ]
    VP23DBG:
      BLDTAG: dbg
      GENDOCS: OFF
  ExtraConfigureArgs: !Sub |
    -DCMAKE_CXX_STANDARD=${Variant:C++Version}
    -DMATERIALX_BUILD_JS=OFF
    -DMATERIALX_BUILD_PYTHON=ON
    -DMATERIALX_BUILD_VIEWER=OFF
    -DMATERIALX_BUILD_GEN_GLSL=ON
    -DMATERIALX_BUILD_GEN_OSL=ON
    -DMATERIALX_BUILD_GEN_MDL=ON
    -DMATERIALX_BUILD_GEN_MSL=ON
    -DMATERIALX_BUILD_GRAPH_EDITOR=OFF
    -DMATERIALX_BUILD_DOCS=${GENDOCS}
    -DMATERIALX_BUILD_RENDER=ON
    -DMATERIALX_BUILD_OIIO=OFF
    -DMATERIALX_BUILD_TESTS=ON
    -DMATERIALX_BUILD_SHARED_LIBS=ON
    -DMATERIALX_PYTHON_LTO=OFF
    -DMATERIALX_INSTALL_PYTHON=ON
    -DMATERIALX_TEST_RENDER=ON
    -DMATERIALX_WARNINGS_AS_ERRORS=OFF
    -DMATERIALX_DYNAMIC_ANALYSIS=OFF
    -DMATERIALX_OSL_LEGACY_CLOSURES=ON
    -DMATERIALX_PYTHON_VERSION=${{PYTHONVERSION}}
    -DMATERIALX_PYTHON_EXECUTABLE=${{WETA_PYTHON_LOCATION}}/bin/python
    -DMATERIALX_OIIO_DIR=${OIIO_LOCATION}
